import { EachTestingContext } from 'twenty-shared/testing';
import { FieldMetadataType } from 'twenty-shared/types';

import { RelationType } from 'src/engine/metadata-modules/field-metadata/interfaces/relation-type.interface';

import { checkFields } from 'src/engine/api/rest/core/query-builder/utils/check-fields.utils';
import { ObjectMetadataItemWithFieldMaps } from 'src/engine/metadata-modules/types/object-metadata-item-with-field-maps';

// TODut somewhere
const OPPORTUNITY_WITH_FIELDS_MAPS = {
  id: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
  nameSingular: 'opportunity',
  namePlural: 'opportunities',
  labelSingular: 'Opportunity',
  labelPlural: 'Opportunities',
  description: 'An opportunity',
  icon: 'IconTargetArrow',
  targetTableName: 'DEPRECATED',
  isCustom: false,
  isRemote: false,
  isActive: true,
  isSystem: false,
  isAuditLogged: true,
  isSearchable: true,
  labelIdentifierFieldMetadataId: '60ae4e32-c2f1-4435-adca-22931f8b41b6',
  imageIdentifierFieldMetadataId: null,
  workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
  indexMetadatas: [], // unused
  fieldsById: {
    '60ae4e32-c2f1-4435-adca-22931f8b41b6': {
      id: '60ae4e32-c2f1-4435-adca-22931f8b41b6',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.TEXT,
      name: 'name',
      label: 'Name',
      defaultValue: "''",
      description: 'The opportunity name',
      icon: 'IconTargetArrow',
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'eed5ffe1-5eef-417a-b517-ebeedaa8e10b': {
      id: 'eed5ffe1-5eef-417a-b517-ebeedaa8e10b',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.CURRENCY,
      name: 'amount',
      label: 'Amount',
      defaultValue: { amountMicros: null, currencyCode: "''" },
      description: 'Opportunity amount',
      icon: 'IconCurrencyDollar',
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '93f291c5-597c-44d3-98ec-ea71aea5256b': {
      id: '93f291c5-597c-44d3-98ec-ea71aea5256b',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.DATE_TIME,
      name: 'closeDate',
      label: 'Close date',
      defaultValue: null,
      description: 'Opportunity close date',
      icon: 'IconCalendarEvent',
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '542b3c00-9b94-454a-94ca-8afb09c68faf': {
      id: '542b3c00-9b94-454a-94ca-8afb09c68faf',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.SELECT,
      name: 'stage',
      label: 'Stage',
      defaultValue: "'NEW'",
      description: 'Opportunity stage',
      icon: 'IconProgressCheck',
      options: [
        {
          id: '0e0e931a-dba8-4975-81bd-b29a41c0a387',
          color: 'red',
          label: 'New',
          value: 'NEW',
          position: 0,
        },
        {
          id: '8944b6bd-1c9d-490c-940c-bf47addcd6a1',
          color: 'purple',
          label: 'Screening',
          value: 'SCREENING',
          position: 1,
        },
        {
          id: '412ae33f-1368-438b-8702-6d5e5727a888',
          color: 'sky',
          label: 'Meeting',
          value: 'MEETING',
          position: 2,
        },
        {
          id: 'f3ea52a3-41e4-4b4e-a038-f02645f55767',
          color: 'turquoise',
          label: 'Proposal',
          value: 'PROPOSAL',
          position: 3,
        },
        {
          id: '86f45bfa-8acf-4934-8519-42f7c9133cd5',
          color: 'yellow',
          label: 'Customer',
          value: 'CUSTOMER',
          position: 4,
        },
      ],
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'bd50d3c3-30a5-4d8e-9b93-12d31ece0aaa': {
      id: 'bd50d3c3-30a5-4d8e-9b93-12d31ece0aaa',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.POSITION,
      name: 'position',
      label: 'Position',
      defaultValue: 0,
      description: 'Opportunity record position',
      icon: 'IconHierarchy2',
      isCustom: false,
      isActive: true,
      isSystem: true,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '860dc096-f95f-424f-ab32-65961e8e9635': {
      id: '860dc096-f95f-424f-ab32-65961e8e9635',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.ACTOR,
      name: 'createdBy',
      label: 'Created by',
      defaultValue: { name: "'System'", source: "'MANUAL'", context: {} },
      description: 'The creator of the record',
      icon: 'IconCreativeCommonsSa',
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'a81c87f6-5e10-4780-babb-38a465ac546c': {
      id: 'a81c87f6-5e10-4780-babb-38a465ac546c',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.TEXT,
      name: 'searchVector',
      label: 'Search vector',
      defaultValue: null,
      description: 'Field used for full-text search',
      icon: 'IconUser',
      isCustom: false,
      isActive: true,
      isSystem: true,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '4d5382b0-8f4a-4f8d-822e-90fe72f75b79': {
      id: '4d5382b0-8f4a-4f8d-822e-90fe72f75b79',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.UUID,
      name: 'id',
      label: 'Id',
      defaultValue: 'uuid',
      description: 'Id',
      icon: 'Icon123',
      isCustom: false,
      isActive: true,
      isSystem: true,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'fed5a74d-f120-4b59-b239-f7f1d8eb243e': {
      id: 'fed5a74d-f120-4b59-b239-f7f1d8eb243e',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.DATE_TIME,
      name: 'createdAt',
      label: 'Creation date',
      defaultValue: 'now',
      description: 'Creation date',
      icon: 'IconCalendar',
      settings: { displayFormat: 'RELATIVE' } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: false,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '126d6d78-dcc8-4318-9756-b87377692561': {
      id: '126d6d78-dcc8-4318-9756-b87377692561',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.DATE_TIME,
      name: 'updatedAt',
      label: 'Last update',
      defaultValue: 'now',
      description: 'Last time the record was changed',
      icon: 'IconCalendarClock',
      settings: { displayFormat: 'RELATIVE' } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: false,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: false,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'd38a6dec-1694-4f8b-8760-61a5ff330022': {
      id: 'd38a6dec-1694-4f8b-8760-61a5ff330022',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.DATE_TIME,
      name: 'deletedAt',
      label: 'Deleted at',
      defaultValue: null,
      description: 'Date when the record was deleted',
      icon: 'IconCalendarMinus',
      settings: { displayFormat: 'RELATIVE' } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    'f6672ee2-4f52-4dea-a116-723f9bf7f082': {
      id: 'f6672ee2-4f52-4dea-a116-723f9bf7f082',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'pointOfContact',
      label: 'Point of Contact',
      defaultValue: null,
      description: 'Opportunity point of contact',
      icon: 'IconUser',
      settings: {
        onDelete: 'SET_NULL',
        relationType: 'MANY_TO_ONE',
        joinColumnName: 'pointOfContactId',
      } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      relationTargetFieldMetadataId: '03d47b5f-a36b-4889-97d4-63a578423688',
      relationTargetObjectMetadataId: '62c2ce6b-6799-4a38-92d3-8e844a7ea8ab',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '467fc358-fc02-4be2-be1a-e121daf5400d': {
      id: '467fc358-fc02-4be2-be1a-e121daf5400d',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'company',
      label: 'Company',
      defaultValue: null,
      description: 'Opportunity company',
      icon: 'IconBuildingSkyscraper',
      settings: {
        onDelete: 'SET_NULL',
        relationType: 'MANY_TO_ONE',
        joinColumnName: 'companyId',
      } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      relationTargetFieldMetadataId: 'f790c82e-bd16-4f63-8165-0a7f5d78170d',
      relationTargetObjectMetadataId: '513aea09-0be8-4764-8e0d-7a2e1c66f78c',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '06e8efca-fd9f-48f0-bd5f-5b0fec6a5de4': {
      id: '06e8efca-fd9f-48f0-bd5f-5b0fec6a5de4',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'favorites',
      label: 'Favorites',
      defaultValue: null,
      description: 'Favorites linked to the opportunity',
      icon: 'IconHeart',
      settings: { relationType: RelationType.ONE_TO_MANY } as any,
      isCustom: false,
      isActive: true,
      isSystem: true,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      relationTargetFieldMetadataId: 'fb7c6533-7c3c-4149-b400-5a958910c7a2',
      relationTargetObjectMetadataId: 'b8d22c13-df10-42dc-baed-ea77db7ad96c',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '3a25add4-88ab-4138-98ce-80533bb423e3': {
      id: '3a25add4-88ab-4138-98ce-80533bb423e3',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'taskTargets',
      label: 'Tasks',
      defaultValue: null,
      description: 'Tasks tied to the opportunity',
      icon: 'IconCheckbox',
      settings: { relationType: RelationType.ONE_TO_MANY } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: false,
      relationTargetFieldMetadataId: 'd8797dbb-eb77-4b1c-b6a6-d5dcd13b1634',
      relationTargetObjectMetadataId: '477afff9-3af1-4c4f-90f4-cd43c53f7f41',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '6f0ea6bd-4258-422b-b35b-db3f090af8da': {
      id: '6f0ea6bd-4258-422b-b35b-db3f090af8da',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'noteTargets',
      label: 'Notes',
      defaultValue: null,
      description: 'Notes tied to the opportunity',
      icon: 'IconNotes',
      settings: { relationType: RelationType.ONE_TO_MANY } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: false,
      relationTargetFieldMetadataId: 'baa8480e-d927-4c91-9893-28cea5aff979',
      relationTargetObjectMetadataId: '48c2de8a-8a5e-4dea-868b-71611e718a73',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '292b289d-16ca-40a7-a1ba-712975c916cd': {
      id: '292b289d-16ca-40a7-a1ba-712975c916cd',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'attachments',
      label: 'Attachments',
      defaultValue: null,
      description: 'Attachments linked to the opportunity',
      icon: 'IconFileImport',
      settings: { relationType: RelationType.ONE_TO_MANY } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      relationTargetFieldMetadataId: '17154f22-9236-427a-8a8a-a2296b93b542',
      relationTargetObjectMetadataId: '1b778c29-3005-4c93-a04c-2941f7424f54',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
    '743966eb-92a5-47bf-a38d-c1c72b2c3e4d': {
      id: '743966eb-92a5-47bf-a38d-c1c72b2c3e4d',
      objectMetadataId: 'b28fec06-6e2c-42f6-a83c-cc58d776af88',
      type: FieldMetadataType.RELATION,
      name: 'timelineActivities',
      label: 'Timeline Activities',
      defaultValue: null,
      description: 'Timeline Activities linked to the opportunity.',
      icon: 'IconTimelineEvent',
      settings: { relationType: RelationType.ONE_TO_MANY } as any,
      isCustom: false,
      isActive: true,
      isSystem: false,
      isNullable: true,
      isUnique: false,
      workspaceId: '20202020-1c25-4d02-bf25-6aeccf7ea419',
      isLabelSyncedWithName: true,
      relationTargetFieldMetadataId: 'fb517a84-2d54-41c7-b886-29deca3c28d5',
      relationTargetObjectMetadataId: '8213a1e3-a89e-4e4d-b3d9-c3f99e7c7483',
      createdAt: new Date('2025-06-27T12:55:13.271Z'),
      updatedAt: new Date('2025-06-27T12:55:13.271Z'),
    },
  },
  fieldIdByName: {
    name: '60ae4e32-c2f1-4435-adca-22931f8b41b6',
    amount: 'eed5ffe1-5eef-417a-b517-ebeedaa8e10b',
    closeDate: '93f291c5-597c-44d3-98ec-ea71aea5256b',
    stage: '542b3c00-9b94-454a-94ca-8afb09c68faf',
    position: 'bd50d3c3-30a5-4d8e-9b93-12d31ece0aaa',
    createdBy: '860dc096-f95f-424f-ab32-65961e8e9635',
    searchVector: 'a81c87f6-5e10-4780-babb-38a465ac546c',
    id: '4d5382b0-8f4a-4f8d-822e-90fe72f75b79',
    createdAt: 'fed5a74d-f120-4b59-b239-f7f1d8eb243e',
    updatedAt: '126d6d78-dcc8-4318-9756-b87377692561',
    deletedAt: 'd38a6dec-1694-4f8b-8760-61a5ff330022',
    pointOfContact: 'f6672ee2-4f52-4dea-a116-723f9bf7f082',
    company: '467fc358-fc02-4be2-be1a-e121daf5400d',
    favorites: '06e8efca-fd9f-48f0-bd5f-5b0fec6a5de4',
    taskTargets: '3a25add4-88ab-4138-98ce-80533bb423e3',
    noteTargets: '6f0ea6bd-4258-422b-b35b-db3f090af8da',
    attachments: '292b289d-16ca-40a7-a1ba-712975c916cd',
    timelineActivities: '743966eb-92a5-47bf-a38d-c1c72b2c3e4d',
  },
  fieldIdByJoinColumnName: {
    pointOfContactId: 'f6672ee2-4f52-4dea-a116-723f9bf7f082',
    companyId: '467fc358-fc02-4be2-be1a-e121daf5400d',
  },
} as const satisfies ObjectMetadataItemWithFieldMaps;

interface CheckFieldsTestContext {
  fields: string[];
  shouldThrow?: boolean;
}

describe('checkFields', () => {
  const testCases: EachTestingContext<CheckFieldsTestContext>[] = [
    {
      title: 'should accept valid join column id',
      context: {
        fields: ['pointOfContactId'],
      },
    },
    {
      title: 'should accept valid relation field name',
      context: {
        shouldThrow: true,
        fields: ['pointOfContact'],
      },
    },
    {
      title: 'should accept valid field name',
      context: {
        fields: ['position'],
      },
    },
    {
      title: 'should reject invalid field name',
      context: {
        fields: ['wrongField'],
        shouldThrow: true,
      },
    },
    {
      title: 'should reject mix of valid and invalid field names',
      context: {
        fields: ['position', 'wrongField'],
        shouldThrow: true,
      },
    },
    {
      title: 'should accept composite field',
      context: {
        // I don't understand how this could work in the graphql API
        // This doesnot need to be formatted as field.subField ?
        fields: ['source'],
      },
    },
  ];

  it.each(testCases)('$title', ({ context }) => {
    if (context.shouldThrow) {
      expect(() =>
        checkFields(OPPORTUNITY_WITH_FIELDS_MAPS, context.fields),
      ).toThrowErrorMatchingSnapshot();
    } else {
      expect(() =>
        checkFields(OPPORTUNITY_WITH_FIELDS_MAPS, context.fields),
      ).not.toThrow();
    }
  });
});
